<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Video Fullscreen con Galleria + Popup Zoom</title>
  <style>
    /* Impostazioni generali */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      font-family: "Viner Hand ITC", cursive, sans-serif;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 0;
      overflow-x: hidden;
    }

    /* Sfondo fisso con overlay scuro */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('./sfondo.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -1;
    }

    /* Contenitore del video principale */
    #video-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
    }

    /* Video principale fullscreen mantenendo le proporzioni */
    #myVideo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      z-index: 2;
    }

    /* Barra pulsanti in fondo: contenuto equidistante senza wrapping */
    #buttons-container {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-evenly;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 0;
      width: 100%;
      box-sizing: border-box;
    }

    /* Container per le icone */
    .icon-container {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      margin: 0 10px;
    }

    /* Icone */
    .icon-wrapper {
      width: 90px;
      height: 60px;
      border: 2px solid #007BFF;
      border-radius: 6px;
      overflow: hidden;
    }

    .icon-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Testo sotto le icone: una sola riga */
    .icon-text {
      color: white;
      font-size: 0.9rem;
      font-weight: bold;
      margin-top: 8px;
      text-align: center;
      max-width: 160px;
      white-space: nowrap;
    }

    /* Container principale per la galleria */
    #gallery-container {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5;
      height: 100vh;
    }

    /* Galleria dinamica - utilizzo ottimizzato dello spazio */
    #gallery {
      width: 100%;
      flex: 1;
      background-color: rgba(17, 17, 17, 0.9);
      padding: 5px;
      /* Ridotto il padding */
      box-sizing: border-box;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      /* Dimensione ridotta */
      grid-gap: 5px;
      /* Spazio ridotto tra le immagini */
      justify-content: center;
      /* Centramento orizzontale */
      align-content: start;
      /* Allineamento verticale in alto */
      z-index: 2;
      margin-bottom: 0;
    }

    .gallery-item {
      width: 100%;
      aspect-ratio: 1/1;
      /* Rapporto quadrato per uniformità */
      background-color: #222;
      overflow: hidden;
      cursor: pointer;
      border-radius: 4px;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
    }

    /* Gallery slider per i video */
    #video-slider-container {
      width: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 10px 0;
      box-sizing: border-box;
      position: relative;
      flex: 0 0 auto;
      height: 200px;
    }

    #video-slider {
      display: flex;
      overflow-x: auto;
      /* Permette lo scorrimento orizzontale */
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding: 0 15px;
      height: 100%;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE and Edge */
    }

    /* Nasconde la scrollbar per Chrome, Safari e Opera */
    #video-slider::-webkit-scrollbar {
      display: none;
    }

    .video-slide {
      flex: 0 0 auto;
      width: 250px;
      margin-right: 15px;
      scroll-snap-align: start;
      border: 2px solid #007BFF;
      border-radius: 6px;
      overflow: hidden;
      background: #111;
      cursor: pointer;
      height: 180px;
    }

    .video-slide img {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }

    .video-title {
      padding: 8px;
      text-align: center;
      color: white;
      font-size: 0.9rem;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.6);
    }

    /* Footer della galleria per il pulsante di ritorno */
    #gallery-footer {
      width: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 15px 0;
      text-align: center;
      z-index: 10;
    }

    #back-to-menu-button {
      padding: 10px 20px;
      background-color: rgba(0, 123, 255, 0.7);
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
    }

    /* Popup immagini */
    #popupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }

    #popupContent {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }

    #popupImg {
      max-width: 100%;
      max-height: calc(100vh - 120px);
      object-fit: contain;
      touch-action: none;
      user-select: none;
      transform-origin: center center;
      flex: 1;
    }

    /* Istruzioni per zoom e rotazione */
    #zoomInstructions {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      margin: 10px 0;
      font-size: 0.9rem;
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      max-width: 90%;
      z-index: 100000;
    }

    #zoomInstructions svg {
      margin-right: 8px;
      width: 24px;
      height: 24px;
    }

    #popupFooter {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 15px 0;
      text-align: center;
      z-index: 100000;
    }

    #closePopupBtn {
      cursor: pointer;
      background-color: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      font-size: 1rem;
      padding: 10px 20px;
    }

    #closePopupBtn:hover {
      background-color: #0056b3;
    }

    /* Popup video statue */
    #videoPopupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #videoPopupContent {
      position: relative;
      max-width: 90%;
      max-height: 80%;
      background-color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border-radius: 6px;
    }

    #statueVideo {
      width: 100%;
      height: auto;
      max-width: 90vw;
      max-height: 80vh;
      object-fit: contain;
      background: #000;
    }

    /* Controlli testuali per il video delle statue */
    #videoTextControls {
      margin-top: 20px;
      color: white;
      font-size: 1rem;
      text-align: center;
    }

    #videoTextControls span {
      margin: 0 10px;
      text-decoration: underline;
      cursor: pointer;
      padding: 8px 16px;
      background: rgba(0, 123, 255, 0.3);
      border-radius: 4px;
    }

    /* Stili specifici per tablet */
    @media (max-width: 1024px) {
      .icon-wrapper {
        width: 70px;
        height: 50px;
      }

      #gallery {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }

      .video-slide {
        width: 200px;
      }
    }

    /* Stili per dispositivi mobili più piccoli */
    @media (max-width: 600px) {
      #buttons-container {
        overflow-x: auto;
        justify-content: center;
      }

      .icon-container {
        margin: 0 8px;
      }

      .icon-wrapper {
        width: 60px;
        height: 40px;
      }

      .icon-text {
        font-size: 0.8rem;
      }

      #gallery {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        padding: 5px;
      }

      /* Per assicurarsi che tutto sia visibile su schermi piccoli */
      #zoomInstructions {
        bottom: 60px;
        font-size: 0.8rem;
        padding: 5px 10px;
      }

      .video-slide {
        width: 180px;
      }

      .video-title {
        font-size: 0.8rem;
      }

      #back-to-menu-button {
        font-size: 0.8rem;
        padding: 8px 12px;
      }
    }

    /* Stile di debug per mostrare errori di caricamento */
    .load-error {
      border: 2px solid red !important;
    }
  </style>
</head>

<body>
  <!-- VIDEO PRINCIPALE -->
  <div id="video-container">
    <video id="myVideo" playsinline>
      <source src="./video/canovaovale.mp4" type="video/mp4">
      Il tuo browser non supporta il tag video.
    </video>
  </div>

  <!-- Container per galleria e relativi elementi -->
  <div id="gallery-container">
    <!-- GALLERIA IMMAGINI -->
    <div id="gallery"></div>

    <!-- GALLERIA VIDEO SLIDER -->
    <div id="video-slider-container">
      <div id="video-slider"></div>
    </div>

    <!-- Footer con pulsante per tornare al menu principale -->
    <div id="gallery-footer">
      <button id="back-to-menu-button">Torna al Menu</button>
    </div>
  </div>

  <!-- BARRA PULSANTI CON ICONE (sempre visibili) -->
  <div id="buttons-container">
    <!-- Icona restart -->
    <div class="icon-container" id="restart-container">
      <div class="icon-wrapper">
        <img src="./icona.png" alt="Icona Restart"
          onerror="this.onerror=null; this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAAA8CAYAAADmBa1FAAAEIklEQVR4Ae2aA9DjQBSF/7Zt27Zt27Zt27Z3bdu2bdu2bc/pZie9k85kW537TvKdmW+bZPLuO7fJBEQWgUz58g2RLOPMeemGLbv22BSHkk9QIAshWQZD5pXr15Fnce1tUvM3MiNZxnIRRJYdcP7dj58/i4dMiLw4tBGDTNeSbyAhhXhk2foPnyF+pKQ4oKGNEGSamLyDP2SJUQGDFhsK9zKQZRlfSEiJQZadtA2ZEMl8YqE1QgqFvOvbmQXQGSsYZ+xtrv2u3xUgWcYXKHFAoIVDJqQ5VzSM1QhB9m9Cfg3+bTcNMiES+cQD1QgCBJlnvunvj3r/+g3UrN8MEsQ9MmNs2Kw1XL91B9i/f7F/yIQUs+sBqhEEADLP/P7DR2jTrRckiH0kRGj96xXgT2Aw7Dl4lB1vYtshE6KMrwYaBCHIPAss7Elzl0D8GPFChM5Wrg78CQkJuHLjFvu39h37mAvZL2QeqUYQBMg8C1TeOfPmgxb2kRCh4+SpAH9DQoNg6fodIMT+6RsyIUbY1UCDIAw5KCgIrt++D2myFWELO0qkyJAgdl72b5F/pEhRoG7ztsz/3cdPUKlWI1NhUYB+XDYDQkxB5mH+p+vHD5Oja1nLITet0wB+h4TA5OVrFUP2C5kQXaCrQUDIcxcuQZx4CVg3kRKmhLRZs8Prtx8gOCQEXrx8DfFiJ/QbtpbBnSZnCRhy9TrkiJ+RdRNl0pfQFFqIERNuvHgAf0ND4fWXd5AxYXrTkDVCoMUCjQAO+carZ5AqZUo488Afjrb/Q5e0SHhNqtwl4M2797B45XpVoW8/uA9pUqSAiw8vQ68aXRWh6TVl/nLw9PSCPMUqsKcCKGTqJpaVqAyRkqUK8Ts4CNqN6w2HFuyD1h26wemrt+HaRX9Ilzo5PH35Gs4/vA0zxi+AfQcOgr+/v2LRRBpqIVSY0RuePX8Jl0+dhZbdepqGTIhZUzagPCYhx/5DpvmLtKUKBTl/eEG2/CzzXuPWcPHgCQgKCoKeIwcy/0jjp6SFHid+bPbx3v2HIPjnr5ChIXuxeOnhX+oSQ77Rr7lyyIQ0dyEZG0IUZMpcpVqN4cfPX9BmUF+2sA7H64dBUaNHh8LVasGdh4/g0rXbMGHUJBbC5esPmGwkQSIiSJIqI1y7dsM05HHLZkG8bNnhV1AQDI77B9q1bgtBwT9Z19Jt9ABWmGNnzIVXr99AtqwZISwsHDJlyQx7jx4PETLGRaYJayYdOVLa0/j7aStWw6OnL1R1HSRKnRXNQKYxP/5Eh8YMFM8fBJk85PjJ0zBj3gJVQ5gQz8XT29nXt+Zov38csmwAwpJkw9ZdfHMI8sMPn0IOQ5Zt+9aRbE627Z1Z2aZk2w5xZRvl2XbgLdv0L9sWQrJt9SUbgr8wUGsKerL+VAAAAABJRU5ErkJggg=='">
      </div>
      <div class="icon-text">Riavvia Presentazione</div>
    </div>
    <!-- Icona galleria -->
    <div class="icon-container" id="gallery-thumbnail-container">
      <div class="icon-wrapper">
        <img src="./galleria.png" alt="Anteprima galleria"
          onerror="this.onerror=null; this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAAA8CAYAAADmBa1FAAAEfklEQVR4Ae2bBZQjORCGv5mZOcMxhJmZmZkv/M4wHDMzM9wxHDMzMzMzM/uwb5PtUSft6Z7prJ58r+pV0lIpdSorUQokKnGPJkXVDdevm1Wbt9PQ4ldyJEuKMsWJeefTr19JK6ncmKJVvClRNVFTWnbwlEUjnVQCZBCFdPHESdTCT58/p+hg/8jxDtJJu2BqR4h0kkXDSidVAIVX0mXbtlPG1FhPICOddKGdIZ10MfwifVVApxEvCOkUbOmkE3Tld+/fq9o9einHSKfsVRvUuw+fVNcRk9XeQ0cNgHYeOKL1vbPHBZSOT0TSSV9R+vrXb5+p/sBRKnXiBOYgp9Vt2FQi33+kOg4YExjSCUcigNJJqmqz9obXX719rzr2G6nSJEpvlqcCg00fPn+jqrfvZQto3L0nkPxLJ2dIpw8fPlLTDj2sIIPqlq8a53t/fKe69B2o8ibLb4mSVq1a+fYdKx07TRo1hNJJq+ofP36qhq16qkSRYlpDfvrhY7Xz0GHVos8glSlpYQus4ZNnKrPbkH5HJpTSSat/9OypatiypwWSBTbWo/PkaWcW2EQ7j55WOQrWULv2H7QVGOSvTt6nkQ5rj6STzqrfvftAtew7XEWLFtUCW7NOMwX6N2/eqXrtuqpsiQtbDEWJq7fr+gvrIeKADRvppFP68dPn1WxFbimHTNI9CjRRnz59UbMWLVfZUha1AFqnektFyvr79x/VoMkTfQM2gNJJs/pLV2+o6lXqqQQJwlXxghXVuw8f1Lote1SBLJUsQqZOly4d1eev39X0ZRtVhniZ/YZMOLxIJ63qD1y4rCpXqqz2X76phpZrqhKEp1RJwlOrrZduqGqVy6mrt+6qpVsOqzzJSwQCNuLwIp20qr9646bKmjGTOnn9jpqcsaWKESuGypKmmFp8+prKnD6tuvXorZq7Yb/KlbRUIGAjDi/SSevsJUtIcbXz+C115MxxtevoWXX+1kN16MQFdeXmY9V/+GSVMFZCCyAX2PA+7G/ppNX/+u0nqmmbzipSzKgqW9VmKnXKVCpVqiQqduRoKkvGjCpypOhWKEsXr6xAeOPOvbHBRnv8Ip20+g4cN0elStdApUuTTkWLEkXFjh5NJYoaVSVLkFgVL51XxYsfSaVKm15ZwnuX7RQ5Z2ZSp82q0qbLpjJmzaXS5ymn4iTPqBIky6DiJc+s4iTJoGIlTKfiJEmn4iXLoJJmzKWyFCrv0nPvyeuEUDpp9adeulqR8mRRh45eUslTpVMpcmRRpOw5leP0GUXKlkUlz5hZkeJmVsmzZVFZixZW6VNl8Lt0OJLJqXTSCnn38YtKlzqlOnzxhMpcuJjKnDWXSpeviMrUso3KVKCwypyvkMrYoIhKX7iYSl+4mMrUtLWO90gfO02OcCST04jnbHAKdM22PY6nQ1+X797vEyRnEcfpw+w66Yzrp1dvdNvvLF2/7/Tx3jGSafDcVe71dfpoM92wfY+UfrTjdALrx+4jXLZ5Bw0qfiVTssQoUxyfcP8BNCiqK7YzwtUAAAAASUVORK5CYII='">
      </div>
      <div class="icon-text">Galleria immagini e audio</div>
    </div>
  </div>

  <!-- POPUP IMMAGINE -->
  <div id="popupOverlay">
    <div id="popupContent">
      <img id="popupImg" src="" alt="Popup Image">
      <div id="zoomInstructions">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M15 3l2.3 2.3-2.89 2.87 1.42 1.42L18.7 6.7 21 9V3h-6zM3 9l2.3-2.3 2.87 2.89 1.42-1.42L6.7 5.3 9 3H3v6zm6 12l-2.3-2.3 2.89-2.87-1.42-1.42L5.3 17.3 3 15v6h6zm12-6l-2.3 2.3-2.87-2.89-1.42 1.42 2.89 2.87L15 21h6v-6z"
            fill="white" />
        </svg>
        <span>Usa due dita per zoomare e ruotare l'immagine</span>
      </div>
      <div id="popupFooter">
        <button id="closePopupBtn">Torna Indietro</button>
      </div>
    </div>
  </div>

  <!-- POPUP VIDEO -->
  <div id="videoPopupOverlay">
    <div id="videoPopupContent">
      <video id="statueVideo" src="" preload="metadata" playsinline></video>
      <div id="videoTextControls">
        <span id="statueReplayText">Riascolta</span>
        <span id="closeVideoPopupText">Torna Indietro</span>
      </div>
    </div>
  </div>

  <script>
    // Rileva ambiente locale
    const isLocalEnvironment = window.location.protocol === 'file:';

    // ELEMENTI HTML
    const myVideo = document.getElementById('myVideo');
    const videoContainer = document.getElementById('video-container');
    const restartContainer = document.getElementById('restart-container');
    const galleryThumbnailContainer = document.getElementById('gallery-thumbnail-container');
    const galleryContainer = document.getElementById('gallery-container');
    const gallery = document.getElementById('gallery');
    const videoSlider = document.getElementById('video-slider');
    const buttonsCont = document.getElementById('buttons-container');
    const backToMenuButton = document.getElementById('back-to-menu-button');

    // Popup immagini
    const popupOverlay = document.getElementById('popupOverlay');
    const popupImg = document.getElementById('popupImg');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const zoomInstructions = document.getElementById('zoomInstructions');

    // Popup video
    const videoPopupOverlay = document.getElementById('videoPopupOverlay');
    const statueVideo = document.getElementById('statueVideo');
    const statueReplayText = document.getElementById('statueReplayText');
    const closeVideoPopupText = document.getElementById('closeVideoPopupText');

    // Verifica disponibilità file - versione locale compatibile
    function checkFile(url, callback) {
      if (isLocalEnvironment) {
        // In ambiente locale, assumiamo che i file esistano
        callback(true);
      } else {
        // Ambiente web
        fetch(url, { method: 'HEAD' })
          .then(response => {
            if (response.ok) {
              callback(true);
            } else {
              callback(false);
            }
          })
          .catch(() => {
            callback(false);
          });
      }
    }

    // Avvio video principale
    function initMainVideo() {
      myVideo.load();

      // Gestione click per avviare il video
      videoContainer.addEventListener('click', () => {
        if (myVideo.paused) {
          myVideo.play();
        } else {
          myVideo.pause();
        }
      }, { once: false });
    }

    // Avvio all'apertura della pagina
    document.addEventListener('DOMContentLoaded', () => {
      initMainVideo();
    });

    // Gestione fine video
    myVideo.addEventListener('ended', () => {
      myVideo.currentTime = 0;
      myVideo.pause();
    });

    // Riavvio video
    restartContainer.addEventListener('click', () => {
      myVideo.currentTime = 0;
      myVideo.play();
    });

    // Variabili per lo scorrimento automatico
    let sliderInterval;
    let userInteracted = false;
    let lastInteractionTime = Date.now();
    const INACTIVITY_TIMEOUT = 5000; // 5 secondi di inattività

    function startSliderAutoScroll() {
      // Ferma eventuali intervalli precedenti
      if (sliderInterval) {
        clearInterval(sliderInterval);
      }

      // Avvia nuovo intervallo
      sliderInterval = setInterval(() => {
        // Controlla se è passato abbastanza tempo dall'ultima interazione
        if (Date.now() - lastInteractionTime > INACTIVITY_TIMEOUT) {
          videoSlider.scrollBy({
            left: 100,
            behavior: 'smooth'
          });

          // Verifica se siamo alla fine e torna all'inizio
          if (videoSlider.scrollLeft + videoSlider.clientWidth >= videoSlider.scrollWidth - 50) {
            videoSlider.scrollTo({
              left: 0,
              behavior: 'smooth'
            });
          }
        }
      }, 3000);
    }

    function stopSliderAutoScroll() {
      if (sliderInterval) {
        clearInterval(sliderInterval);
      }
    }

    // Aggiorna il timestamp dell'ultima interazione
    function updateInteractionTime() {
      lastInteractionTime = Date.now();
    }

    // Gestione touch per lo slider
    let touchStartX = 0;
    let touchEndX = 0;
    let isDragging = false;

    function setupSliderTouchEvents() {
      videoSlider.addEventListener('touchstart', function (e) {
        touchStartX = e.changedTouches[0].screenX;
        isDragging = true;
        updateInteractionTime(); // Aggiorna timestamp interazione
      }, { passive: true });

      videoSlider.addEventListener('touchmove', function (e) {
        if (!isDragging) return;
        updateInteractionTime(); // Aggiorna timestamp interazione
        touchEndX = e.changedTouches[0].screenX;
        const scrollX = touchStartX - touchEndX;
        videoSlider.scrollLeft += scrollX;
        touchStartX = touchEndX;
      }, { passive: true });

      videoSlider.addEventListener('touchend', function () {
        isDragging = false;
      }, { passive: true });
    }

    // GESTIONE GALLERIA DINAMICA con fallback migliorato
    function populateGallery() {
      gallery.innerHTML = '';
      videoSlider.innerHTML = '';

      // Calcola dinamicamente quante immagini per riga in base alla larghezza
      const galleryWidth = gallery.clientWidth;
      const imgSize = 120; // Dimensione base delle miniature
      const gap = 5; // Spazio tra le immagini (deve corrispondere al grid-gap)

      // Aggiungi immagini normali
      for (let i = 1; i <= 17; i++) {
        const div = document.createElement('div');
        div.className = 'gallery-item';

        const img = document.createElement('img');
        const imgPath = `./immagini/${i}.jpg`;

        // Verifica immagine e imposta fallback
        img.onerror = function () {
          this.onerror = null;
          this.src = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%23777" width="100" height="100"/><text fill="%23fff" font-family="Arial" font-size="14" x="10" y="50">Immagine ${i}</text></svg>`;
          this.parentNode.classList.add('load-error');
        };

        img.src = imgPath;
        img.alt = `Immagine numero ${i}`;
        img.loading = "lazy"; // Aggiunge lazy loading per migliorare le prestazioni

        img.addEventListener('click', () => openImagePopup(imgPath));
        div.appendChild(img);
        gallery.appendChild(div);
      }

      // Aggiungi video allo slider
      for (let i = 1; i <= 7; i++) {
        const slide = document.createElement('div');
        slide.className = 'video-slide';
        slide.setAttribute('data-video', `./video/video${i}.mp4`);

        // Crea un'anteprima per il video
        const thumbnail = document.createElement('img');
        thumbnail.src = `./immagini/statue${i}.jpg`;
        thumbnail.onerror = function () {
          this.onerror = null;
          this.src = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%23555" width="100" height="100"/><text fill="%23fff" font-family="Arial" font-size="14" x="10" y="50">Video ${i}</text></svg>`;
        };

        const title = document.createElement('div');
        title.className = 'video-title';
        title.textContent = `Statua ${i}`;

        slide.appendChild(thumbnail);
        slide.appendChild(title);

        // Implementazione click singolo invece di doppio click
        slide.addEventListener('click', function () {
          openVideoPopup(this.getAttribute('data-video'));
        });

        videoSlider.appendChild(slide);
      }

      // Aggiungi evento scroll al video slider per aggiornare l'interazione
      videoSlider.addEventListener('scroll', updateInteractionTime);

      // Configura eventi touch per lo slider
      setupSliderTouchEvents();

      // Avvia lo scorrimento automatico
      startSliderAutoScroll();
    }

    // Apertura popup video
    function openVideoPopup(videoSrc) {
      statueVideo.src = videoSrc;
      videoPopupOverlay.style.display = 'flex';
      statueVideo.load();
      statueVideo.play();
    }

    // Chiusura popup video
    function closeVideoPopup() {
      videoPopupOverlay.style.display = 'none';
      statueVideo.pause();
      statueVideo.currentTime = 0;
    }

    // Apertura galleria
    galleryThumbnailContainer.addEventListener('click', () => {
      myVideo.pause();
      populateGallery();

      // Nascondi il contenitore del video
      videoContainer.style.display = 'none';

      // Mostra container della galleria
      galleryContainer.style.display = 'flex';

      // Aggiorna lo stato del pulsante galleria
      galleryThumbnailContainer.style.opacity = "0.5";
      restartContainer.style.opacity = "1";
    });

    // Ritorno al menu principale
    function backToMain() {
      // Ferma lo scorrimento automatico
      stopSliderAutoScroll();

      // Nascondi galleria
      galleryContainer.style.display = 'none';

      // Mostra di nuovo il contenitore del video
      videoContainer.style.display = 'flex';

      // Reimposta l'opacità dei pulsanti
      galleryThumbnailContainer.style.opacity = "1";
    }

    backToMenuButton.addEventListener('click', backToMain);

    // Variabili per pinch & rotate (popup immagini)
    let currentScale = 1;
    let currentRotate = 0;
    let startDistance = 0;
    let startAngle = 0;
    let initialScale = 1;
    let initialRotate = 0;
    const activePointers = {};

    // POPUP IMMAGINE con gestione errori e istruzioni zoom
    function openImagePopup(src) {
      popupImg.onerror = function () {
        this.onerror = null;
        this.src = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200" viewBox="0 0 300 200"><rect fill="%23333" width="300" height="200"/><text fill="%23fff" font-family="Arial" font-size="16" x="50" y="100">Immagine non disponibile</text></svg>`;
      };

      popupImg.src = src;
      popupOverlay.style.display = 'flex';
      currentScale = 1;
      currentRotate = 0;
      popupImg.style.transform = `scale(${currentScale}) rotate(${currentRotate}deg)`;

      // Mostra le istruzioni di zoom solo su dispositivi touch
      if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        zoomInstructions.style.display = 'flex';
      } else {
        zoomInstructions.style.display = 'none';
      }
    }

    function closeImagePopup() {
      popupOverlay.style.display = 'none';
    }

    closePopupBtn.addEventListener('click', closeImagePopup);

    // Gestione touch per zoom e rotazione
    function onPointerDown(e) {
      e.preventDefault();
      popupImg.setPointerCapture(e.pointerId);
      activePointers[e.pointerId] = e;
      if (Object.keys(activePointers).length === 2) prepareTransform();
    }

    function onPointerMove(e) {
      if (!activePointers[e.pointerId]) return;
      activePointers[e.pointerId] = e;
      if (Object.keys(activePointers).length === 2) doTransform();
    }

    function onPointerUpOrCancel(e) {
      popupImg.releasePointerCapture(e.pointerId);
      delete activePointers[e.pointerId];
    }

    function prepareTransform() {
      const [p1, p2] = Object.values(activePointers);
      startDistance = getDistance(p1, p2);
      startAngle = getAngle(p1, p2);
      initialScale = currentScale;
      initialRotate = currentRotate;
    }

    function doTransform() {
      const [p1, p2] = Object.values(activePointers);
      const newDistance = getDistance(p1, p2);
      const newAngle = getAngle(p1, p2);
      const scaleFactor = newDistance / startDistance;
      currentScale = initialScale * scaleFactor;
      const angleDiff = newAngle - startAngle;
      currentRotate = initialRotate + angleDiff;
      if (currentScale < 0.5) currentScale = 0.5;
      if (currentScale > 5.0) currentScale = 5.0;
      popupImg.style.transform = `scale(${currentScale}) rotate(${currentRotate}deg)`;
    }

    function getDistance(e1, e2) {
      const dx = e2.clientX - e1.clientX;
      const dy = e2.clientY - e1.clientY;
      return Math.hypot(dx, dy);
    }

    function getAngle(e1, e2) {
      const dx = e2.clientX - e1.clientX;
      const dy = e2.clientY - e1.clientY;
      const radians = Math.atan2(dy, dx);
      return radians * (180 / Math.PI);
    }

    popupImg.addEventListener('pointerdown', onPointerDown);
    popupImg.addEventListener('pointermove', onPointerMove);
    popupImg.addEventListener('pointerup', onPointerUpOrCancel);
    popupImg.addEventListener('pointercancel', onPointerUpOrCancel);

    // Controlli video popup
    statueReplayText.addEventListener('click', () => {
      statueVideo.currentTime = 0;
      statueVideo.play();
    });

    closeVideoPopupText.addEventListener('click', closeVideoPopup);

    // Chiusura popup su click all'esterno
    popupOverlay.addEventListener('click', e => {
      if (e.target === popupOverlay) closeImagePopup();
    });

    videoPopupOverlay.addEventListener('click', e => {
      if (e.target === videoPopupOverlay) closeVideoPopup();
    });

    // Gestione errori per il video principale
    myVideo.addEventListener('error', function () {
      videoContainer.innerHTML = '<div style="color:white;text-align:center;padding:20px;"><p>Video non disponibile.</p><p>Tocca per riprovare</p></div>';
      videoContainer.addEventListener('click', () => {
        videoContainer.innerHTML = '<video id="myVideo" playsinline><source src="./video/canovaovale.mp4" type="video/mp4">Il tuo browser non supporta il tag video.</video>';
        myVideo = document.getElementById('myVideo');
        initMainVideo();
      });
    });

    // Controllo online/offline per dispositivi mobili
    window.addEventListener('online', function () {
      if (myVideo.paused && myVideo.error) {
        initMainVideo();
      }
    });
  </script>
</body>

</html>